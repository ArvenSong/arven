<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <meta charset="UTF-8"/>
    <title>文件上传</title>
    <link rel="stylesheet" href="/static/layui/css/layui.css" th:href="@{/layui/css/layui.css}" media="all"/>
    <script src="/static/layui/layui.all.js" th:src="@{/layui/layui.all.js}"></script>
    <script src="/static/js/jquery-3.2.1.min.js" th:src="@{/js/jquery-3.2.1.min.js}"></script>
    <style type="text/css">
        span {
            display: block;
            text-align: center;
        }
    </style>
</head>
<body>

<div style="margin-top: 100px;">
    <div class="layui-form">
        <input type="hidden" id="file"/>
        <span class="layui-form-item" style="width: 50%;margin: auto;">
            <label class="layui-form-label">标签tag：</label>
            <div class="layui-input-block">
                <input class="layui-input" id="tag_id" type="hidden"/>
                <input class="layui-input" id="tag" type="text" placeholder="请输入标签..."/>
                <button class="layui-btn layui-btn-danger layui-btn-radius" onclick="tagClear()">清空</button>
                <br>
                <br>
            </div>
        </span>

        可选标签：
        <input type="checkbox" class="tag_checkbox" th:value="${tag.id}" th:each="tag : ${tagList}"
               th:title="${tag.name}">
        <br/>
        <br/>
        <br/>
        <span>
            <button type="button" class="layui-btn layui-btn-warm layui-btn-radius" id="ticket">
                <i class="layui-icon">&#xe67c;</i>上传文件
            </button>
            <br/>
            <p id="msg" style="text-align: center;color: #0000FF"></p>
            <br/>
            <!--<a id="source" title="点击查看原图" target="_blank">
                <img src="#" id="picture" style="display: none;" width="200px"/>
            </a>-->
        </span>
    </div>
    <div id="show"></div>
    <br/><br/>
</div>
<script type="text/javascript" th:inline="javascript">
    /*<![CDATA[*/
    ctxPath = /*[[@{/}]]*/ '';

    /*]]>*/

    function setTag() {
        var name = "";
        var tagId = "";
        $(".tag_checkbox:checked").each(function () {
            name += this.title+",";
            tagId += this.value+",";
        });
        if(name!="") {
            name = name.substr(0,name.length-1);
            tagId = tagId.substr(0,tagId.length-1);
        }
        $("#tag").val(name);
        $("#tag_id").val(tagId);
    }

    function tagClear() {
        $("#tag").val("");
        $("#tag_id").val("");
    }

    layui.use('upload', function () {
        var upload = layui.upload;

        //执行实例
        var uploadInst = upload.render({
            elem: '#ticket' //绑定元素
            , multiple: true
            , accept: 'file'
            , url: ctxPath + 'manage/upload' //上传接口
            , data: {
                'tag': function () {
                    return $("#tag_id").val();
                }
            }
            , done: function (res) {
                //上传完毕回调
                var fileId = res.fileId;
                $("#file").val(fileId);
                $("#msg").text("文件已上传。");
                // $("#picture").css("display", "");
                // $("#picture").attr("src", ctxPath + "view/breviary/" + fileId);
                // $("#source").attr("href", ctxPath + "view/truth/" + fileId);
                var src = ctxPath + "manage/view/breviary/" + fileId;
                var str = $("#show").html();
                str += "<img src='" + src + "' width='200px'/>";
                $("#show").html(str);
                layer.msg("上传成功！")
            }
            , error: function () {
                layer.msg("上传失败！")
            }, allDone: function (obj) { //当文件全部被提交后，才触发
                var str = "得到总文件数: " + obj.total + "</br>请求成功的文件数: " + obj.successful + "</br>请求失败的文件数: " + obj.aborted;
                $("#msg").html(str);
            }
        });
    });

    layui.use('form', function () {
        var form = layui.form;
        form.on('checkbox', function (data) {
            setTag();
        });
        form.render();
    });
</script>
</body>
</html>